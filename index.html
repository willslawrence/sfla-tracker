<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SFLA Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #C4A052;
      --primary-dark: #9A7B3C;
      --suitable: #22c55e;
      --suitable-stale: #eab308;
      --suitable-old: #f97316;
      --unsuitable: #6b7280;
      --pending: #ef4444;
      --route: #e879f9;
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --text: #f0f0f0;
      --text-muted: #9ca3af;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
    }
    #map { height: 100vh; width: 100%; }
    
    /* Dark leaflet popup - HIDDEN (using custom info panel) */
    .leaflet-popup { display: none !important; }
    
    /* Top info panel */
    #info-panel {
      position: fixed;
      top: 16px;
      left: 16px;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 12px 14px;
      max-width: 200px;
      z-index: 1001;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      display: none;
    }
    #info-panel.active { display: block; }
    #info-panel .panel-name {
      font-size: 15px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 6px;
    }
    #info-panel .panel-status {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    #info-panel .panel-date {
      font-size: 10px;
      color: var(--text-muted);
    }
    #info-panel .panel-area {
      font-size: 11px;
      color: var(--text);
      margin-top: 4px;
      font-weight: 500;
    }
    #info-panel .panel-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
    }
    #info-panel textarea {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 8px;
      color: var(--text);
      font-size: 12px;
      font-family: inherit;
      resize: none;
      height: 40px;
      margin-top: 8px;
    }
    #info-panel textarea::placeholder { color: var(--text-muted); }
    
    /* Radial action buttons */
    #radial-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }
    #radial-menu.active { display: block; }
    
    .radial-btn {
      position: absolute;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      font-size: 20px;
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      transition: transform 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .radial-btn:active { transform: scale(0.9); }
    .radial-btn.btn-suitable { background: var(--suitable); color: white; }
    .radial-btn.btn-unsuitable { background: var(--unsuitable); color: white; }
    .radial-btn.btn-close { 
      background: rgba(255,255,255,0.9); 
      color: #333; 
      width: 36px; 
      height: 36px; 
      font-size: 16px; 
    }
    
    .radial-line {
      position: absolute;
      background: rgba(255,255,255,0.4);
      height: 2px;
      transform-origin: left center;
      pointer-events: none;
    }
    
    /* Popup styling */
    .popup-name { 
      font-size: 22px; 
      font-weight: 700; 
      margin-bottom: 12px;
      color: var(--primary);
    }
    .popup-info { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-muted);
    }
    .popup-info span:last-child { color: var(--text); font-weight: 500; }
    
    .popup-status {
      display: inline-block;
      padding: 4px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-suitable { background: var(--suitable); color: white; }
    .status-suitable-stale { background: var(--suitable-stale); color: white; }
    .status-suitable-old { background: var(--suitable-old); color: white; }
    .status-unsuitable { background: var(--unsuitable); color: white; }
    .status-pending { background: var(--pending); color: white; }
    
    .popup-notes {
      margin: 14px 0;
    }
    .popup-notes textarea {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 60px;
    }
    .popup-notes textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .popup-notes textarea::placeholder { color: var(--text-muted); }
    
    .popup-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .popup-btn {
      flex: 1;
      padding: 14px 10px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    .popup-btn:active { transform: scale(0.97); }
    .popup-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-suitable { background: var(--suitable); color: white; }
    .btn-unsuitable { background: var(--unsuitable); color: white; }
    
    /* Controls */
    .controls {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .control-btn {
      width: 44px;
      height: 44px;
      background: var(--bg-card);
      border: none;
      border-radius: 12px;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .control-btn:hover { background: var(--primary-dark); }
    .control-btn.active { background: var(--primary); }
    
    /* Legend - HIDDEN */
    .legend { display: none; }
    .map-legend {
      position: absolute;
      bottom: 30px;
      left: 10px;
      z-index: 1000;
      background: rgba(20, 20, 30, 0.45);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 9px;
      color: rgba(200,200,200,0.8);
    }
    .map-legend h4 {
      margin: 0 0 3px;
      font-size: 9px;
      color: rgba(255,255,255,0.8);
      font-weight: 600;
    }
    .map-legend .legend-row {
      display: flex;
      align-items: center;
      gap: 5px;
      margin: 2px 0;
    }
    .map-legend .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      display: inline-block;
    }
    
    /* Shape labels */
    .shape-label {
      background: transparent;
      border: none;
      color: white;
      font-size: 11px;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8), 0 0 2px rgba(0,0,0,0.9);
      white-space: nowrap;
    }
    
    /* Location dot */
    .my-location {
      width: 16px;
      height: 16px;
      background: #3b82f6;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(59,130,246,0.5);
    }
    .my-location.following {
      animation: pulse-loc 1.5s ease-in-out infinite;
    }
    @keyframes pulse-loc {
      0%, 100% { box-shadow: 0 0 10px rgba(59,130,246,0.5); }
      50% { box-shadow: 0 0 20px rgba(59,130,246,0.8), 0 0 40px rgba(59,130,246,0.3); }
    }
    
    /* Location accuracy circle */
    .accuracy-circle {
      background: rgba(59,130,246,0.1);
      border: 1px solid rgba(59,130,246,0.3);
      border-radius: 50%;
    }
    
    /* Hide default leaflet controls */
    .leaflet-control-zoom { display: none; }
    .gps-label {
      background: rgba(0,0,0,0.7) !important;
      border: 1px solid #00ffff !important;
      color: #00ffff !important;
      font-size: 11px !important;
      font-weight: bold !important;
      padding: 2px 6px !important;
      border-radius: 3px !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-legend">
    <h4>SFLA Status</h4>
    <div class="legend-row"><span class="dot" style="background:#4caf50"></span> Current</div>
    <div class="legend-row"><span class="dot" style="background:#ffeb3b"></span> Review</div>
    <div class="legend-row"><span class="dot" style="background:#ff9800"></span> Review Overdue</div>
    <div class="legend-row"><span class="dot" style="background:#f44336"></span> New SFLA</div>
  </div>
  
  <div class="controls">
    <button class="control-btn" id="btnLocation" title="My Location">üìç</button>
    <button class="control-btn" id="btnSatellite" title="Satellite View">üõ∞Ô∏è</button>
    <button class="control-btn" id="btnZoomIn" title="Zoom In">+</button>
    <button class="control-btn" id="btnZoomOut" title="Zoom Out">‚àí</button>
  </div>
  
  <!-- Top info panel -->
  <div id="info-panel">
    <button class="panel-close" onclick="closePanel()">‚úï</button>
    <div class="panel-name" id="panelName"></div>
    <div class="panel-status" id="panelStatus"></div>
    <div class="panel-area" id="panelArea"></div>
    <div class="panel-date" id="panelDate"></div>
    <textarea id="panelNotes" placeholder="Notes..."></textarea>
  </div>

  <!-- Radial action buttons -->
  <div id="radial-menu">
    <div class="radial-line" id="lineSuitable"></div>
    <div class="radial-line" id="lineUnsuitable"></div>
    <button class="radial-btn btn-suitable" id="radialSuitable">‚úì</button>
    <button class="radial-btn btn-unsuitable" id="radialUnsuitable">‚úó</button>
    <button class="radial-btn btn-close" id="radialClose">‚úï</button>
  </div>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="shapes.js"></script>
  <script>
    // Config
    const AIRTABLE_BASE = 'appBJW3FvPw5c659F';
    const AIRTABLE_TABLE = 'Sites';
    const API_KEY = 'patLbOrwwrjme5vN3.ae163eba9b6d38277421312fdc531ab473e61d841e7dede3bf592b475a8c0a54';
    
    // Colors
    const COLORS = {
      suitable: '#22c55e',
      suitableStale: '#eab308',
      suitableOld: '#f97316',
      unsuitable: '#6b7280',
      pending: '#ef4444',
      route: '#e879f9'
    };
    
    // Calculate days since date
    function daysSince(dateStr) {
      if (!dateStr) return Infinity;
      const then = new Date(dateStr);
      const now = new Date();
      return Math.floor((now - then) / (1000 * 60 * 60 * 24));
    }
    
    // Get color based on status and age
    function getShapeColor(status, lastChecked) {
      if (status === 'Unsuitable') return COLORS.unsuitable;
      if (status === 'Pending' || status === 'New SFLA' || !status || status === 'Unknown') return COLORS.pending;
      
      if (status === 'Suitable') {
        const days = daysSince(lastChecked);
        if (days >= 28) return COLORS.suitableOld;    // 4+ weeks
        if (days >= 21) return COLORS.suitableStale;   // 3+ weeks
        return COLORS.suitable;                        // Fresh
      }
      
      return COLORS.pending;
    }
    
    // Get status class for popup
    function getStatusClass(status, lastChecked) {
      if (status === 'Unsuitable') return 'status-unsuitable';
      if (status === 'Pending' || status === 'New SFLA' || !status || status === 'Unknown') return 'status-pending';
      
      if (status === 'Suitable') {
        const days = daysSince(lastChecked);
        if (days >= 28) return 'status-suitable-old';
        if (days >= 21) return 'status-suitable-stale';
        return 'status-suitable';
      }
      
      return 'status-pending';
    }
    
    // Get display status
    function getDisplayStatus(status, lastChecked) {
      if (status === 'Unsuitable') return 'Unsuitable';
      if (status === 'Pending' || !status || status === 'Unknown') return 'Pending Review';
      
      if (status === 'Suitable') {
        const days = daysSince(lastChecked);
        if (days >= 28) return 'Suitable (4+ wks)';
        if (days >= 21) return 'Suitable (3+ wks)';
        return 'Suitable';
      }
      
      return 'Pending Review';
    }
    
    // Map layers
    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '¬©OpenStreetMap, ¬©CARTO'
    });
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬©Esri'
    });
    
    // Initialize map
    const map = L.map('map', {
      center: [24.78, 46.74],
      zoom: 13,
      layers: [darkLayer],
      zoomControl: false,
      tap: true,
      tapTolerance: 20
    });
    
    let isSatellite = false;
    let polygons = {};
    let labels = {};
    let siteData = {};
    let locationMarker = null;
    let selectedShape = null;
    let selectedPoly = null;
    
    // UI elements
    const infoPanel = document.getElementById('info-panel');
    const radialMenu = document.getElementById('radial-menu');
    const radialSuitable = document.getElementById('radialSuitable');
    const radialUnsuitable = document.getElementById('radialUnsuitable');
    const radialClose = document.getElementById('radialClose');
    const lineSuitable = document.getElementById('lineSuitable');
    const lineUnsuitable = document.getElementById('lineUnsuitable');
    
    // Toggle satellite
    document.getElementById('btnSatellite').addEventListener('click', function() {
      isSatellite = !isSatellite;
      this.classList.toggle('active', isSatellite);
      if (isSatellite) {
        map.removeLayer(darkLayer);
        map.addLayer(satelliteLayer);
      } else {
        map.removeLayer(satelliteLayer);
        map.addLayer(darkLayer);
      }
    });
    
    // Zoom controls
    document.getElementById('btnZoomIn').addEventListener('click', () => map.zoomIn());
    document.getElementById('btnZoomOut').addEventListener('click', () => map.zoomOut());
    
    // Location tracking state
    let watchId = null;
    let isFollowing = false;
    let accuracyCircle = null;
    const btnLocation = document.getElementById('btnLocation');
    
    function startFollowing() {
      isFollowing = true;
      btnLocation.classList.add('active');
      btnLocation.textContent = 'üìç';
      if (locationMarker) {
        locationMarker.getElement()?.classList.add('following');
      }
    }
    
    function stopFollowing() {
      isFollowing = false;
      btnLocation.classList.remove('active');
      if (locationMarker) {
        locationMarker.getElement()?.classList.remove('following');
      }
    }
    
    function updateLocation(pos) {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      const accuracy = pos.coords.accuracy;
      
      if (locationMarker) {
        locationMarker.setLatLng(latlng);
      } else {
        locationMarker = L.marker(latlng, {
          icon: L.divIcon({ className: 'my-location following', iconSize: [16, 16] })
        }).addTo(map);
      }
      
      // Accuracy circle
      if (accuracyCircle) {
        accuracyCircle.setLatLng(latlng).setRadius(accuracy);
      } else {
        accuracyCircle = L.circle(latlng, {
          radius: accuracy,
          className: 'accuracy-circle',
          stroke: true,
          color: 'rgba(59,130,246,0.3)',
          fillColor: 'rgba(59,130,246,0.08)',
          weight: 1
        }).addTo(map);
      }
      
      if (isFollowing) {
        map.setView(latlng, Math.max(map.getZoom(), 14), { animate: true });
      }
    }
    
    btnLocation.addEventListener('click', function() {
      if (watchId !== null && isFollowing) {
        // Already following ‚Äî just re-center (in case user wants to snap back)
        if (locationMarker) {
          map.setView(locationMarker.getLatLng(), Math.max(map.getZoom(), 14), { animate: true });
        }
        return;
      }
      
      if (watchId !== null && !isFollowing) {
        // Was tracking but user panned away ‚Äî resume following
        startFollowing();
        if (locationMarker) {
          map.setView(locationMarker.getLatLng(), Math.max(map.getZoom(), 14), { animate: true });
        }
        return;
      }
      
      // First activation ‚Äî start watching
      this.textContent = '‚è≥';
      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          startFollowing();
          updateLocation(pos);
        },
        (err) => {
          alert('Could not get location');
          this.textContent = 'üìç';
          watchId = null;
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
      );
    });
    
    // Stop following when user manually drags/pans the map
    map.on('dragstart', () => {
      if (isFollowing) stopFollowing();
    });
    
    // Format area
    function formatArea(m2) {
      if (m2 >= 10000) return (m2 / 10000).toFixed(1) + ' ha';
      return m2.toLocaleString() + ' m¬≤';
    }
    
    // Render routes
    function renderRoutes() {
      if (typeof ROUTES !== 'undefined') {
        ROUTES.forEach(route => {
          L.polyline(route.coords, {
            color: COLORS.route,
            weight: 4,
            dashArray: '10, 10',
            opacity: 0.9
          }).addTo(map).bindPopup(`<div class="popup-name">${route.name}</div>`);
        });
      }
    }
    
    // Render GPS points as labeled pins
    function renderGPSPoints() {
      if (typeof GPS_POINTS !== 'undefined') {
        GPS_POINTS.forEach(pt => {
          const marker = L.circleMarker([pt.lat, pt.lng], {
            radius: 6,
            fillColor: '#00ffff',
            color: '#fff',
            weight: 2,
            fillOpacity: 0.9
          }).addTo(map);
          marker.bindTooltip(pt.name, {
            permanent: true,
            direction: 'right',
            offset: [8, 0],
            className: 'gps-label'
          });
        });
      }
    }

    // Load site data from Airtable
    async function loadSiteData() {
      try {
        let allRecords = [];
        let offset = null;
        
        do {
          const url = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${AIRTABLE_TABLE}?pageSize=100${offset ? '&offset=' + offset : ''}`;
          const resp = await fetch(url, {
            headers: { 'Authorization': `Bearer ${API_KEY}` }
          });
          const data = await resp.json();
          allRecords = allRecords.concat(data.records || []);
          offset = data.offset;
        } while (offset);
        
        // Index by name
        allRecords.forEach(r => {
          siteData[r.fields['SFLA Name'] || r.fields.Name] = r;
        });
        
        renderRoutes();
        renderGPSPoints();
        renderShapes();
      } catch (err) {
        console.error('Failed to load:', err);
      }
    }
    
    // Render shapes
    function renderShapes() {
      SHAPES.forEach(shape => {
        const site = siteData[shape.name];
        const status = site?.fields?.Status || 'Pending';
        const lastChecked = site?.fields?.LastChecked;
        const color = getShapeColor(status, lastChecked);
        
        // Polygon with increased weight for easier tapping
        const poly = L.polygon(shape.coords, {
          color: color,
          fillColor: color,
          fillOpacity: 0.4,
          weight: 5  // Increased from 2
        }).addTo(map);
        
        poly.on('click', (e) => {
          L.DomEvent.stopPropagation(e);
          showRadialMenu(shape, poly, e.latlng);
        });
        polygons[shape.name] = poly;
        
        // Label
        const label = L.marker(shape.center, {
          icon: L.divIcon({
            className: 'shape-label',
            html: shape.name,
            iconSize: null
          })
        }).addTo(map);
        labels[shape.name] = label;
      });
    }
    
    // Update shape color
    function updateShapeColor(name, status, lastChecked) {
      const poly = polygons[name];
      if (poly) {
        const color = getShapeColor(status, lastChecked);
        poly.setStyle({ color, fillColor: color });
      }
    }
    
    // Draw line helper
    function drawLine(lineEl, x1, y1, x2, y2) {
      const dx = x2 - x1;
      const dy = y2 - y1;
      const length = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      lineEl.style.left = x1 + 'px';
      lineEl.style.top = y1 + 'px';
      lineEl.style.width = length + 'px';
      lineEl.style.transform = `rotate(${angle}deg)`;
    }
    
    // Show radial menu
    function showRadialMenu(shape, poly, latlng) {
      // Deselect previous
      if (selectedPoly) {
        const prevSite = siteData[selectedShape.name];
        const prevStatus = prevSite?.fields?.Status || 'Pending';
        const prevLastChecked = prevSite?.fields?.LastChecked;
        const prevColor = getShapeColor(prevStatus, prevLastChecked);
        selectedPoly.setStyle({ weight: 5 });
      }
      
      selectedShape = shape;
      selectedPoly = poly;
      
      // Highlight selected
      poly.setStyle({ weight: 7 });
      poly.bringToFront();
      
      // Update info panel
      const site = siteData[shape.name];
      const status = site?.fields?.Status || 'Pending';
      const lastChecked = site?.fields?.LastChecked;
      const lastCheckedDisplay = lastChecked 
        ? new Date(lastChecked).toLocaleDateString('en-GB') 
        : 'Never';
      const notes = site?.fields?.Notes || '';
      
      document.getElementById('panelName').textContent = shape.name;
      document.getElementById('panelStatus').textContent = getDisplayStatus(status, lastChecked);
      document.getElementById('panelArea').textContent = shape.area_m2 ? formatArea(shape.area_m2) : '';
      document.getElementById('panelDate').textContent = `Last: ${lastCheckedDisplay}`;
      document.getElementById('panelNotes').value = notes;
      infoPanel.classList.add('active');
      
      // Position radial buttons
      const point = map.latLngToContainerPoint(latlng);
      const cx = point.x;
      const cy = point.y;
      const radius = 65;
      
      // Suitable - top left
      const angle1 = -Math.PI * 3/4;
      const x1 = cx + Math.cos(angle1) * radius - 24;
      const y1 = cy + Math.sin(angle1) * radius - 24;
      radialSuitable.style.left = x1 + 'px';
      radialSuitable.style.top = y1 + 'px';
      
      // Unsuitable - top right
      const angle2 = -Math.PI / 4;
      const x2 = cx + Math.cos(angle2) * radius - 24;
      const y2 = cy + Math.sin(angle2) * radius - 24;
      radialUnsuitable.style.left = x2 + 'px';
      radialUnsuitable.style.top = y2 + 'px';
      
      // Close - bottom
      radialClose.style.left = (cx - 18) + 'px';
      radialClose.style.top = (cy + radius - 18) + 'px';
      
      // Draw lines
      drawLine(lineSuitable, cx, cy, x1 + 24, y1 + 24);
      drawLine(lineUnsuitable, cx, cy, x2 + 24, y2 + 24);
      
      radialMenu.classList.add('active');
    }
    
    // Close panel and radial
    function closePanel() {
      infoPanel.classList.remove('active');
      radialMenu.classList.remove('active');
      if (selectedPoly) {
        selectedPoly.setStyle({ weight: 5 });
      }
      selectedShape = null;
      selectedPoly = null;
    }
    
    // Radial button handlers
    radialSuitable.addEventListener('click', () => {
      if (selectedShape) saveStatus('Suitable');
    });
    radialUnsuitable.addEventListener('click', () => {
      if (selectedShape) saveStatus('Unsuitable');
    });
    radialClose.addEventListener('click', closePanel);
    
    // Close on map click
    map.on('click', closePanel);
    
    // Update radial position on map move
    map.on('move', () => {
      if (selectedShape && radialMenu.classList.contains('active')) {
        const latlng = selectedShape.center;
        const point = map.latLngToContainerPoint(latlng);
        const cx = point.x;
        const cy = point.y;
        const radius = 65;
        
        const angle1 = -Math.PI * 3/4;
        radialSuitable.style.left = (cx + Math.cos(angle1) * radius - 24) + 'px';
        radialSuitable.style.top = (cy + Math.sin(angle1) * radius - 24) + 'px';
        
        const angle2 = -Math.PI / 4;
        radialUnsuitable.style.left = (cx + Math.cos(angle2) * radius - 24) + 'px';
        radialUnsuitable.style.top = (cy + Math.sin(angle2) * radius - 24) + 'px';
        
        radialClose.style.left = (cx - 18) + 'px';
        radialClose.style.top = (cy + radius - 18) + 'px';
        
        drawLine(lineSuitable, cx, cy, cx + Math.cos(angle1) * radius, cy + Math.sin(angle1) * radius);
        drawLine(lineUnsuitable, cx, cy, cx + Math.cos(angle2) * radius, cy + Math.sin(angle2) * radius);
      }
    });
    
    // Log change to Change Log table
    async function logChange(siteName, previousStatus, newStatus, notes) {
      try {
        await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/Change%20Log`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fields: {
              Name: siteName,
              Timestamp: new Date().toISOString(),
              PreviousStatus: previousStatus || 'Pending',
              NewStatus: newStatus,
              Notes: notes || ''
            }
          })
        });
      } catch (err) {
        console.warn('Change log failed:', err);
      }
    }

    // Increment check count on site record
    async function incrementCheckCount(recordId, currentCount) {
      try {
        await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${AIRTABLE_TABLE}/${recordId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fields: { CheckCount: (currentCount || 0) + 1 }
          })
        });
      } catch (err) {
        console.warn('Check count update failed:', err);
      }
    }

    // Save status
    async function saveStatus(status) {
      if (!selectedShape) return;
      
      const name = selectedShape.name;
      const site = siteData[name];
      const recordId = site?.id;
      const previousStatus = site?.fields?.Status || 'Pending';
      const notes = document.getElementById('panelNotes').value || '';
      
      // Disable buttons
      radialSuitable.disabled = true;
      radialUnsuitable.disabled = true;
      
      const today = new Date().toISOString().split('T')[0];
      
      try {
        const resp = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${AIRTABLE_TABLE}/${recordId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fields: {
              Status: status,
              Notes: notes,
              LastChecked: today
            }
          })
        });
        
        if (!resp.ok) throw new Error('Save failed');
        
        const updated = await resp.json();
        siteData[name] = updated;
        updateShapeColor(name, status, today);
        
        // Log only actual status changes or new SFLAs
        if (previousStatus !== status) {
          logChange(name, previousStatus, status, notes);
        }
        
        // Always increment check count
        incrementCheckCount(recordId, site?.fields?.CheckCount || 0);
        
        closePanel();
        
      } catch (err) {
        console.error('Save error:', err);
        alert('Failed to save. Try again.');
      } finally {
        radialSuitable.disabled = false;
        radialUnsuitable.disabled = false;
      }
    }
    
    // Init
    loadSiteData();
  </script>
</body>
</html>
